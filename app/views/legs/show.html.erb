<p id="notice"><%= notice %></p>

<p>
  <strong>Title:</strong>
  <%= @leg.title %>
</p>

<p>
  <strong>Description:</strong>
  <%= @leg.description %>
</p>

<h2>Locations in this Leg</h2>
<% if @locations = @leg.locations %>
  <% @start = @locations.first %>
  <% @end = @locations.last %>
  <%= render :partial => 'locations/list' %>
<% end %>

<div style='width: 800px;'>
  <div id="map" style='width: 800px; height: 400px;'></div>
</div>

<!--
<script type="text/javascript">
  handler = Gmaps.build('Google');
  handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
    markers = handler.addMarkers(<%= raw @leg_hash.to_json %>);
    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();
  });
</script>
-->

<script type="text/javascript">
  var directionsDisplay;
  var directionsService = new google.maps.DirectionsService();
  var map;
  var markerArray = [];
  var waypts = [];

  function initialize() {
    directionsDisplay = new google.maps.DirectionsRenderer();
    var start_point = new google.maps.LatLng(<%= @start.latitude %>, <%= @start.longitude %>);
    var mapOptions = {
      zoom:7,
      center: start_point
    };
    map = new google.maps.Map(document.getElementById('map'), mapOptions);
    directionsDisplay.setMap(map);
  }

  function calcRoute() {
    initialize();
    
    <% @count = 0 %>
    
    // Add waypoints
    for (var i = 0; i < <%= @locations.size %>; i++) {
      
      <% @waypoint = @locations[@count] %>
      <% @count += 1 %>

      waypts.push({
        location: new google.maps.LatLng(<%= @waypoint.latitude %>, <%= @waypoint.longitude %>),
        stopover: true
      });

    }  
    
    var start = new google.maps.LatLng(<%= @start.latitude %>, <%= @start.longitude %>);
    var end = new google.maps.LatLng(<%= @end.latitude %>, <%= @end.longitude %>);
    
    var request = {
        origin:start,
        destination:end,
        optimizeWaypoints: false, //true,
        travelMode: google.maps.TravelMode.DRIVING,
        waypoints: waypts
    };
    
    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
        var route = response.routes[0];
        var summaryPanel = document.getElementById('directions_panel');
        summaryPanel.innerHTML = '';
        // For each route, display summary information.
        for (var i = 0; i < route.legs.length; i++) {
          var routeSegment = i + 1;
          summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment + '</b><br>';
          summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
          summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
          summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
        }
      }
    });
  }

  google.maps.event.addDomListener(window, 'load', calcRoute);
</script>

<div id="directions_panel" style="margin:20px;background-color:#FFEE77;"></div>

<h2>Create and Add a New Location</h2>
<%= render 'locations/form' %>

<%= link_to 'Edit', edit_leg_path(@leg) %> |
<%= link_to 'Back', legs_path %>
